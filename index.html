<!DOCTYPE html><html lang="ru"><head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Создать заявку — Пятак</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="/styles.css" rel="stylesheet">
<script src="/config.js?v=1" defer></script>
</head><body>
<nav class="navbar navbar-expand-lg border-bottom mb-3">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="/index.html">
      <img src="/assets/logo.svg" height="24" alt="logo"><span>Пятак — заявки</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link active" href="/index.html">Создать заявку</a></li>
        <li class="nav-item"><a class="nav-link" href="/history.html">История заявок</a></li>
        <li class="nav-item"><a class="nav-link" href="/calculator.html">Калькулятор</a></li>
        <li class="nav-item"><a class="nav-link" href="/tips.html">Советы</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container" style="max-width:820px">
  <div class="card p-4 p-md-5">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="hero-title m-0">Создать заявку</h3>
      <span class="badge-pill">Время Алматы · 20:00 дедлайн по умолчанию</span>
    </div>
    <div class="mb-3">
      <label class="form-label" for="club">Клуб</label>
      <select id="club" class="form-select">
        <option value="" selected disabled>Выберите клуб</option>
        <option value="pyatak">Пятак</option>
        <option value="premium">Пятак Premium</option>
        <option value="level">Пятак Level</option>
      </select>
    </div>
    <div class="mb-3">
      <label class="form-label" for="pc">ПК / Зона</label>
      <select id="pc" class="form-select" disabled>
        <option>Сначала выберите клуб</option>
      </select>
      <div class="form-text">Есть «Кассовый ПК», «Кибер-отель 1/2», «Другое».</div>
    </div>
    <div class="mb-3">
      <label class="form-label" for="desc">Описание проблемы</label>
      <textarea id="desc" class="form-control" rows="3" placeholder="Коротко и по делу…"></textarea>
    </div>
    <div class="mb-3">
      <label class="form-label d-block">Срок исполнения</label>
      <div class="d-flex gap-3 flex-wrap">
        <div class="form-check"><input class="form-check-input" type="radio" name="deadline" id="dl_today" value="Сегодня"><label class="form-check-label" for="dl_today">Сегодня</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="deadline" id="dl_tomorrow" value="Завтра"><label class="form-check-label" for="dl_tomorrow">Завтра</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="deadline" id="dl_3days" value="3 дня"><label class="form-check-label" for="dl_3days">3 дня</label></div>
      </div>
    </div>
    <div class="d-grid gap-2">
      <button id="sendBtn" class="btn btn-primary btn-lg">Отправить заявку</button>
      <div id="result" class="text-center small"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const pcEl = $('#pc'), clubEl = $('#club'), btn = $('#sendBtn'), res = $('#result');

  function clubs(){ return (typeof CONFIG!=='undefined' && CONFIG.clubs) ? CONFIG.clubs : {}; }
  function API(){ return (typeof CONFIG!=='undefined' && CONFIG.API_URL) ? CONFIG.API_URL : ""; }
  const pad=n=>String(n).padStart(2,'0');
  const localIsoNoZ=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

  function fillPC(){
    const all = clubs(); const key = clubEl.value;
    pcEl.innerHTML=''; if(!all[key]){ pcEl.innerHTML='<option>Сначала выберите клуб</option>'; pcEl.disabled=true; return; }
    const c = all[key]; pcEl.disabled=false;
    for(let i=1;i<=c.pcs;i++){ const o=document.createElement('option'); o.value=o.textContent=`ПК ${i}`; pcEl.appendChild(o); }
    (c.extras||[]).concat(c.hotel||[]).forEach(n=>{ const o=document.createElement('option'); o.value=o.textContent=n; pcEl.appendChild(o); });
    const o=document.createElement('option'); o.value=o.textContent='Другое'; pcEl.appendChild(o);
  }

  async function submit(){
    const all = clubs(); const key = clubEl.value; const title = all[key]?.title || '';
    const pc = pcEl.value; const desc = $('#desc').value.trim();
    const deadlineLabel = document.querySelector('input[name="deadline"]:checked')?.value;

    if(!key||!pc||!desc||!deadlineLabel){ res.innerHTML="<span class='text-danger'>Заполните все поля.</span>"; return; }
    if(desc.length<4){ res.innerHTML="<span class='text-danger'>Описание слишком короткое.</span>"; return; }

    const now=new Date(); let d=new Date(now);
    if(deadlineLabel==="Сегодня"){ d.setHours(20,0,0,0); }
    if(deadlineLabel==="Завтра"){ d.setDate(d.getDate()+1); d.setHours(20,0,0,0); }
    if(deadlineLabel==="3 дня"){ d.setDate(d.getDate()+3); d.setHours(20,0,0,0); }

    const payload={ club:title, pc, description:desc, deadline_iso:localIsoNoZ(d) };

    try{
      btn.disabled=true; btn.textContent="Отправка…"; res.textContent="";
      let r=await fetch(`${API()}/api/tickets`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      if(!r.ok && (r.status===502||r.status===503)){ await new Promise(s=>setTimeout(s,4000)); r=await fetch(`${API()}/api/tickets`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}); }
      const text=await r.text(); let data; try{data=JSON.parse(text);}catch{data={ok:false,error:text};}
      if(!r.ok||!data.ok) throw new Error(data.error||"server_error");
      res.innerHTML=`<span class="text-success">Готово. ID заявки: <b>${data.id}</b></span>`; $('#desc').value="";
    }catch(e){ res.innerHTML=`<span class="text-danger">Не удалось отправить: ${e.message}</span>`; }
    finally{ btn.disabled=false; btn.textContent="Отправить заявку"; }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    pcEl.innerHTML='<option>Сначала выберите клуб</option>'; pcEl.disabled=true;
    clubEl.addEventListener('change', fillPC);
    btn.addEventListener('click', submit);
  });
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body></html>

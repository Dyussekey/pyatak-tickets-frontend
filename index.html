<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Создать заявку — Пятак</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">

  <!-- Конфиг должен грузиться раньше любых наших скриптов -->
  <script src="/config.js?v=3"></script>

  <script>
    // Fallback на случай, если /config.js не подхватился (кэш/ошибка)
    if (typeof CONFIG === 'undefined') {
      window.CONFIG = {
        API_URL: "https://pyatak-tickets-api.onrender.com",
        clubs: {
          pyatak:{ key:"pyatak", title:"Пятак", pcs:76, extras:["Кассовый ПК"], hotel:[] },
          premium:{ key:"premium", title:"Пятак Premium", pcs:40, extras:["Кибер-отель 1","Кибер-отель 2","Кассовый ПК"], hotel:[] },
          level:{ key:"level", title:"Пятак Level", pcs:30, extras:["Кассовый ПК"], hotel:[] }
        }
      };
    }

    // Вспомогалки
    const pad = n => String(n).padStart(2,'0');
    const localIsoNoZ = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;

    function getApiUrl(){ return (typeof CONFIG!=='undefined' && CONFIG.API_URL) ? CONFIG.API_URL : "https://pyatak-tickets-api.onrender.com"; }
    function getClubs(){ return (typeof CONFIG!=='undefined' && CONFIG.clubs) ? CONFIG.clubs : {}; }

    function fillPCList() {
      const clubs = getClubs();
      const clubKey = document.getElementById('club').value;
      const pcEl = document.getElementById('pc');

      pcEl.innerHTML = '';
      if (!clubKey || !clubs[clubKey]) {
        pcEl.innerHTML = '<option>Сначала выберите клуб</option>';
        pcEl.disabled = true;
        return;
      }

      const club = clubs[clubKey];
      pcEl.disabled = false;

      for (let i = 1; i <= (club.pcs || 0); i++) {
        const o = document.createElement('option');
        o.value = `ПК ${i}`; o.textContent = `ПК ${i}`;
        pcEl.appendChild(o);
      }
      (club.extras || []).forEach(name => {
        const o = document.createElement('option'); o.value = name; o.textContent = name; pcEl.appendChild(o);
      });
      (club.hotel || []).forEach(name => {
        const o = document.createElement('option'); o.value = name; o.textContent = name; pcEl.appendChild(o);
      });
      const other = document.createElement('option'); other.value = 'Другое'; other.textContent = 'Другое'; pcEl.appendChild(other);
    }

    async function submitForm() {
      const btn = document.getElementById('sendBtn');
      const res = document.getElementById('result');
      const clubs = getClubs();

      const clubSel = document.getElementById('club');
      const clubKey = clubSel.value;
      const clubTitle = clubs[clubKey]?.title || '';
      const pc = document.getElementById('pc').value;
      const desc = document.getElementById('desc').value.trim();
      const deadlineLabel = document.querySelector('input[name="deadline"]:checked')?.value;

      if (!clubKey || !pc || !desc || !deadlineLabel) { res.innerHTML="<span class='text-danger'>Заполните все поля.</span>"; return; }
      if (desc.length < 4) { res.innerHTML="<span class='text-danger'>Описание слишком короткое.</span>"; return; }

      const now = new Date(); let d = new Date(now);
      if (deadlineLabel === "Сегодня") { d.setHours(20,0,0,0); }
      if (deadlineLabel === "Завтра")  { d.setDate(d.getDate()+1); d.setHours(20,0,0,0); }
      if (deadlineLabel === "3 дня")   { d.setDate(d.getDate()+3); d.setHours(20,0,0,0); }

      const payload = { club: clubTitle, pc, description: desc, deadline_iso: localIsoNoZ(d) };
      const API = getApiUrl();

      try {
        btn.disabled = true; btn.textContent = "Отправка…"; res.textContent = "";
        let r = await fetch(`${API}/api/tickets`, {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
        });
        if (!r.ok && (r.status===502 || r.status===503)) {
          await new Promise(s=>setTimeout(s,4000));
          r = await fetch(`${API}/api/tickets`, {
            method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload)
          });
        }
        const text = await r.text(); let data; try{ data=JSON.parse(text);}catch{ data={ok:false,error:text}; }
        if (!r.ok || !data.ok) throw new Error(data.error || "server_error");
        res.innerHTML = `<span class="text-success">Готово. ID заявки: <b>${data.id}</b></span>`;
        document.getElementById('desc').value = "";
      } catch(e) {
        res.innerHTML = `<span class="text-danger">Не удалось отправить: ${e.message}</span>`;
      } finally {
        btn.disabled = false; btn.textContent = "Отправить заявку";
      }
    }

    // Привязка событий после построения DOM
    document.addEventListener('DOMContentLoaded', () => {
      const clubEl = document.getElementById('club');
      const pcEl   = document.getElementById('pc');

      // начальное состояние
      pcEl.innerHTML = '<option>Сначала выберите клуб</option>';
      pcEl.disabled = true;

      // надежная привязка (без inline onchange)
      clubEl.addEventListener('change', fillPCList);

      // подсветка активного пункта меню
      document.querySelectorAll('.nav-link').forEach(a=>{
        const path = location.pathname.replace(/\/$/,'') || '/index.html';
        const href = a.getAttribute('href');
        if (href === path || (path==='/index.html' && href==='/')) a.classList.add('active');
      });
    });
  </script>
</head>
<body>
  <!-- Навигация -->
  <nav class="navbar navbar-expand-lg bg-light border-bottom">
    <div class="container">
      <a class="navbar-brand" href="/index.html">Пятак — заявки</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="nav" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="/index.html">Создать заявку</a></li>
          <li class="nav-item"><a class="nav-link" href="/history.html">История заявок</a></li>
          <li class="nav-item"><a class="nav-link" href="/calculator.html">Калькулятор</a></li>
          <li class="nav-item"><a class="nav-link" href="/tips.html">Советы</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container" style="max-width:720px;margin-top:42px;margin-bottom:42px">
    <div class="card p-4 p-md-5">
      <h3 class="mb-3 text-center">Создать заявку</h3>
      <p class="text-center muted mb-4">Клубы: Пятак, Пятак Premium, Пятак Level</p>

      <!-- Клуб -->
      <div class="mb-3">
        <label class="form-label" for="club">Клуб</label>
        <select id="club" class="form-select">
          <option value="" selected disabled>Выберите клуб</option>
          <option value="pyatak">Пятак</option>
          <option value="premium">Пятак Premium</option>
          <option value="level">Пятак Level</option>
        </select>
      </div>

      <!-- ПК -->
      <div class="mb-3">
        <label class="form-label" for="pc">ПК / Зона</label>
        <select id="pc" class="form-select" disabled>
          <option>Сначала выберите клуб</option>
        </select>
        <div class="form-text">Есть «Кассовый ПК», «Кибер-отель 1/2» и «Другое».</div>
      </div>

      <!-- Описание -->
      <div class="mb-3">
        <label class="form-label" for="desc">Описание проблемы</label>
        <textarea id="desc" class="form-control" rows="3" placeholder="Коротко и по делу…"></textarea>
      </div>

      <!-- Срок -->
      <div class="mb-3">
        <label class="form-label d-block">Срок исполнения</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="deadline" id="dl_today" value="Сегодня">
          <label class="form-check-label" for="dl_today">Сегодня</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="deadline" id="dl_tomorrow" value="Завтра">
          <label class="form-check-label" for="dl_tomorrow">Завтра</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" name="deadline" id="dl_3days" value="3 дня">
          <label class="form-check-label" for="dl_3days">3 дня</label>
        </div>
        <div class="form-text">Дедлайн фиксируется на 20:00 по локальному времени.</div>
      </div>

      <!-- Кнопка -->
      <div class="d-grid gap-2">
        <button id="sendBtn" class="btn btn-primary btn-lg" onclick="submitForm()">Отправить заявку</button>
        <div id="result" class="text-center small"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

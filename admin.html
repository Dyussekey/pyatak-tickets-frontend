<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Заявки — Админ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#f6f7f9}.card{border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}</style>
</head>
<body>
<div class="container" style="max-width:1000px;margin-top:36px;margin-bottom:36px">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">Список заявок</h3>
    <div>
      <select id="fStatus" class="form-select form-select-sm d-inline-block" style="width:160px">
        <option value="">Все статусы</option>
        <option value="new" selected>Только NEW</option>
        <option value="in_progress">В работе</option>
        <option value="done">Выполнено</option>
      </select>
      <select id="fClub" class="form-select form-select-sm d-inline-block" style="width:200px">
        <option value="">Все клубы</option>
        <option>Пятак</option>
        <option>Пятак Premium</option>
        <option>Пятак Level</option>
      </select>
      <button class="btn btn-sm btn-primary" onclick="loadList()">Обновить</button>
    </div>
  </div>

  <div class="card p-3">
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>ID</th><th>Клуб</th><th>ПК</th><th>Описание</th><th>Дедлайн</th><th>Статус</th><th style="width:140px">Действия</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="7">Загрузка…</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API = "https://pyatak-tickets-api.onrender.com";
function fmt(dt){ try{const d=new Date(dt);return d.toLocaleString("ru-RU",{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'})}catch{return dt}}
async function loadList(){
  const s = document.getElementById('fStatus').value;
  const c = document.getElementById('fClub').value;
  const q = new URLSearchParams(); if(s) q.set('status',s); if(c) q.set('club',c); q.set('limit','200');
  const r = await fetch(`${API}/api/tickets?`+q.toString()); const data = await r.json();
  const tb = document.getElementById('rows'); tb.innerHTML = "";
  if(!data.ok){ tb.innerHTML = `<tr><td colspan="7" class="text-danger">Ошибка загрузки</td></tr>`; return; }
  if(data.items.length===0){ tb.innerHTML = `<tr><td colspan="7" class="text-muted">Пусто</td></tr>`; return; }
  for(const t of data.items){
    const tr = document.createElement('tr');
    const overdue = (new Date(t.deadline) < new Date()) && t.status!=='done';
    tr.innerHTML = `
      <td>${t.id}</td>
      <td>${t.club}</td>
      <td>${t.pc}</td>
      <td>${t.description}</td>
      <td${overdue?' class="text-danger fw-semibold"':''}>${fmt(t.deadline)}</td>
      <td>${t.status}</td>
      <td>
        <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-secondary" ${t.status==='in_progress'?'disabled':''}
            onclick="setStatus(${t.id},'in_progress')">В работе</button>
          <button class="btn btn-success" ${t.status==='done'?'disabled':''}
            onclick="setStatus(${t.id},'done')">Готово</button>
        </div>
      </td>`;
    tb.appendChild(tr);
  }
}
async function setStatus(id, status){
  const r = await fetch(`${API}/api/tickets/${id}/status`, {
    method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({status})
  });
  const ok = r.ok && (await r.json()).ok; if(!ok){ alert("Не удалось обновить статус"); return; }
  loadList();
}
loadList();
</script>
</body>
</html>
